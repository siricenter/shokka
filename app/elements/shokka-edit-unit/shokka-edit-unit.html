<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../shokka-team-modal/shokka-team-modal.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">

<dom-module id="shokka-edit-unit">
  <template>
    <style include="shared-styles"></style>
    <style>
      :host {
        display: block;
      }
    </style>
      <firebase-collection  location="{{unitsLocation}}"
                            equal-to="{{parentType}}"
                            order-by-child="type"
                            data="{{possibleParents}}"></firebase-collection>
      <paper-material elevation="1">
        <firebase-document  id="firebaseUnit"
                            location="{{unitLocation}}"
                            data="{{unit}}"></firebase-document>
        <h1><paper-input value="{{unit.name}}" label="Name"></paper-input></h1>
        <paper-dropdown-menu hidden="{{isPortfolio}}" label="Parent">
          <paper-menu class="dropdown-content" attr-for-selected="value" selected="{{unit.parent}}" on-selected-changed="foo">
            <template is="dom-repeat" items="{{possibleParents}}" as="possibleParent">
              <paper-item value="{{possibleParent.__firebaseKey__}}">{{possibleParent.name}}</paper-item>
            </template>
          </paper-menu>
        </paper-dropdown-menu>
        <h1>Children</h1>
        <template is="dom-repeat" items={{possibleChildren}} as="child" filter="_isChildType">
          <paper-material>
            <a href='{{childPath}}/{{child.__firebaseKey__}}'>{{child.name}}{{child.fName}} {{child.lName}}</a>
            <paper-button value={{child}} raised on-tap="_removeChild">x</paper-button>
          </paper-material>
        </template>
        <firebase-collection  id="possibleChildrenCollection"
                              location="{{firebaseCollectionProperties.location}}"
                              order-by-child="{{firebaseCollectionProperties.orderByChild}}"
                              data="{{possibleChildren}}"></firebase-collection>
        <paper-dropdown-menu label="Add Existing Child">
          <paper-menu id="childMenu" class="dropdown-content" attr-for-selected="value" selected={{child}}>
            <template is="dom-repeat" items={{possibleChildren}} as="child" filter="_hasNoParent">
              <paper-item value={{child}}>{{child.name}}{{child.fName}} {{child.lName}}</paper-item>
            </template>
          </paper-menu>
        </paper-dropdown-menu>
        <paper-button raised on-click="_addChild">+</paper-button>
        <paper-button raised on-tap="_createChild">New Child</paper-button>
        <h2>Parent</h2>
        <p><a href='{{parentPath}}'>Up</a></p>
        <paper-button raised>DELETE</paper-button>
      </paper-material>
    </template>
  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'shokka-edit-unit',

        properties: {
        },

        observers: [
          '_resetFirebaseCollection(unitId)',
          '_setFirebaseCollection(baseRef, orgId, unitId, unit)',
          '_setUnitLocation(baseRef, orgId, unitId)',
          '_setUnitsLocation(baseRef, orgId)',
          '_setPaths(unit)',
          '_onIdChange(id)'
        ],

        foo: function(e) {
          var ref;
          ref = new Firebase(this.unitsLocation + '/' + e.target.selected + '/children/' + this.unitId); // jshint ignore:line
          ref.set(true);
        },

        _addChild: function() {
          var ref;
          if (this.childType === 'user') {
            ref = new Firebase(this.firebaseCollectionProperties.location + '/' + this.$.childMenu.selected.__firebaseKey__ + '/groups/' + this.unitId); // jshint ignore:line
            ref.set(true);
          } else {
            ref = new Firebase(this.firebaseCollectionProperties.location + '/' + this.$.childMenu.selected.__firebaseKey__ + '/parent'); // jshint ignore:line
            ref.set(this.unitId);
          }
          ref = new Firebase(this.unitLocation + '/children/' + this.$.childMenu.selected.__firebaseKey__); // jshint ignore:line
          ref.set(true);
        },

        _isChildType: function(child) {
          return (this.childType === 'user' && ((child || {}).groups || {})[this.unitId] === true) ? true : (child.type === this.childType && child.parent === this.unitId) ? true : false;
        },

        _hasNoParent: function(child) {
          return (this.childType === 'user' && ((child || {}).groups || {})[this.unitId] !== true) ? true : (child.type !== this.childType) ? false : !child.parent; 
        },

        _removeChild: function(e) {
          var ref;
          (this.childType === 'user') ?
            ref = new Firebase(this.firebaseCollectionProperties.location + '/' + e.target.value.__firebaseKey__ + '/groups/' + this.unitId) : // jshint ignore:line
            ref = new Firebase(this.firebaseCollectionProperties.location + '/' + e.target.value.__firebaseKey__ + '/parent'); // jshint ignore:line
          ref.set(null);
        },

        _createChild: function() {
          var ref = this.$.possibleChildrenCollection;
          if (this.unit.type === 'portfolio') {
            window.page('#!/teams/' + ref.add({type: 'team', parent: this.unitId}).key());
          } else if(this.unit.type === 'team') {
            window.page('#!/groups/' + ref.add({type: 'group', parent: this.unitId}).key());
          } else if(this.unit.type === 'group') {
            // Will need to implement a sign-in for the user and to write to base level users
            var user = {};
            user.name = 'New User';
            user.teams = {};
            user.teams[this.unitId] = true;
            window.page('#!/users/' + ref.add(user).key());
          }
        },

        _setPaths: function(unit) {
          this.isPortfolio = false;
          if (unit.type === 'portfolio') {
            this.isPortfolio = true;
            this.parentPath = '/';
            this.childPath = 'teams';
            this.parentType = null;
            this.childType = 'team';
          } else if (unit.type === 'team') {
            this.parentPath = '/portfolios/';
            this.childPath = 'groups';
            this.parentType = 'portfolio';
            this.childType = 'group';
          } else if (unit.type === 'group') {
            this.parentPath = '/teams/';
            this.childPath = 'users';
            this.parentType = 'team';
            this.childType = 'user';
          } else {
            this.parentPath = '#';
            this.childPath = '#';
          }
          this.parentPath += unit.parent || '';
        },

        _resetFirebaseCollection: function() {
          this.firebaseCollectionProperties = null;
        },

        _setFirebaseCollection: function(baseRef, orgId, unitId, unit) {
          var firebaseCollectionArray = [
            {
              // For porfolios or teams
              orderByChild: 'parent',
              orderValueType: 'string',
              equalTo: unitId,
              location: baseRef + '/orgs/' + orgId + '/units'
            },
            {
              // for groups because they are special
              orderByChild: 'teams/' + unitId,
              orderValueType: 'boolean',
              equalTo: 'true',
              location: baseRef + '/orgs/' + orgId + '/users'
            }
          ];

          this.firebaseCollectionProperties = firebaseCollectionArray[(unit || {}).type === 'group' ? 1 : 0];
        },

        _setUnitLocation: function(baseRef, orgId, unitId) {
          this.unitLocation = baseRef + '/orgs/' + orgId + '/units/' + unitId;
        },

        _setUnitsLocation: function(baseRef, orgId) {
          this.unitsLocation = baseRef + '/orgs/' + orgId + '/units';
        },

        _onIdChange: function() {
          this.unitId = this.id;
        }

      });
    })();
  </script>

</dom-module>

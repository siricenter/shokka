<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../shokka-trainings-list/shokka-trainings-list.html">

<dom-module id="shokka-categories">
  <template>
    <style>
      :host {
        display: block;
      }

      paper-material > paper-material {
        width: 256px;
      }
    </style>
    <firebase-collection  id="categoryCollection"
                          location="{{categoriesLocation}}"
                          data="{{categories}}"></firebase-collection>
    <firebase-collection  location="{{modulesLocation}}"
                          data="{{modules}}"></firebase-collection>
    <firebase-collection  location="{{groupsLocation}}"
                          order-by-child="type"
                          equal-to="group"
                          data="{{groups}}"></firebase-collection>
    <template is="dom-repeat" items="{{categories}}" as="category">
      <paper-card heading="{{category.name}}">
        <template is="dom-repeat" items="{{_toKeyArray(category.modules)}}" as="moduleId">
          <shokka-module  base-ref="[[baseRef]]"
                          module-id="[[moduleId]]"
                          org-id="[[orgId]]"></shokka-module>
          <paper-button category={{category}} module-id={{moduleId}} raised on-tap="_removeModule">x</paper-button>
          <div></div>
        </template>
        <paper-dropdown-menu label="Add Module">
          <paper-menu name="moduleMenu" class="dropdown-content" attr-for-selected="value">
            <template is="dom-repeat" items={{modules}} as="module">
              <paper-item value={{module}}>{{module.name}}</paper-item>
            </template>
          </paper-menu>
        </paper-dropdown-menu>
        <paper-button category={{category}} raised on-tap="_addModule">+</paper-button>
        <hr>
        <template is="dom-repeat" items="{{_toKeyArray(category.groups)}}" as="groupId">
          <div>Group Name: 
          <shokka-unit-name base-ref="[[baseRef]]"
                            unit-id="[[groupId]]"
                            org-id="[[orgId]]"></shokka-unit-name></div>
          <paper-button category={{category}} group-id={{groupId}} raised on-tap="_removeFromGroup">x</paper-button>
          <div></div>
        </template>
        <paper-dropdown-menu label="Add to Group">
          <paper-menu id="childMenu" class="dropdown-content" attr-for-selected="value">
            <template is="dom-repeat" items={{groups}} as="group">
              <paper-item value={{group}}>{{group.name}}</paper-item>
            </template>
          </paper-menu>
        </paper-dropdown-menu>
        <paper-button category={{category}} raised on-tap="_addToGroup">+</paper-button>
        <paper-button category={{category}} raised on-tap="_removeCategory">DELETE CATEGORY</paper-button>
      </paper-card>
    </template>
    <paper-button raised on-tap="_createCategory">o</paper-button>
  </template>

  <script>
    (function () {
      'use strict';

      Polymer({
        is: 'shokka-categories',
        properties: {
        },

        observers: [
          '_setLocations(baseRef, orgId)'
        ],

        _addModule: function(e) {
          var module = (Polymer.dom(((e.currentTarget || {}).previousElementSibling || {})).firstElementChild || {}).selected;
          var category = (e.currentTarget || {}).category;
          var ref = new Firebase(this.categoriesLocation + '/' + category.__firebaseKey__ + '/modules/' + module.__firebaseKey__); // jshint ignore:line
          ref.set(true);
          var ref = new Firebase(this.modulesLocation + '/' + module.__firebaseKey__ + '/categories/' + category.__firebaseKey__); // jshint ignore:line
          ref.set(true);
        },

        _removeModule: function(e) {
          var ref = new Firebase(this.categoriesLocation + '/' + e.currentTarget.category.__firebaseKey__ + '/modules/' + e.currentTarget.moduleId); // jshint ignore:line
          ref.remove();
          var ref = new Firebase(this.modulesLocation + '/' + e.currentTarget.moduleId + '/categories/' + e.currentTarget.category.__firebaseKey__); // jshint ignore:line
          ref.remove();
        },

        _addToGroup: function(e) {
          var group = (Polymer.dom(((e.currentTarget || {}).previousElementSibling || {})).firstElementChild || {}).selected;
          var category = (e.currentTarget || {}).category;
          var ref = new Firebase(this.categoriesLocation + '/' + category.__firebaseKey__ + '/groups/' + group.__firebaseKey__); // jshint ignore:line
          ref.set(true);
          var ref = new Firebase(this.groupsLocation + '/' + group.__firebaseKey__ + '/categories/' + category.__firebaseKey__); // jshint ignore:line
          ref.set(true);
        },

        _removeFromGroup: function(e) {
          var ref = new Firebase(this.categoriesLocation + '/' + e.currentTarget.category.__firebaseKey__ + '/groups/' + e.currentTarget.groupId); // jshint ignore:line
          ref.remove();
          var ref = new Firebase(this.groupsLocation + '/' + e.currentTarget.groupId + '/categories/' + e.currentTarget.category.__firebaseKey__); // jshint ignore:line
          ref.remove();
        },

        _setLocations: function(baseRef, orgId) {
          if (!baseRef || !orgId) {
            this.modulesLocation = null;
          }
          this.modulesLocation = baseRef + '/orgs/' + orgId + '/modules';
          this.categoriesLocation = baseRef + '/orgs/' + orgId + '/categories';
          this.groupsLocation = baseRef + '/orgs/' + orgId + '/units';
        },

        _createCategory: function() {
          this.$.categoryCollection.add({name: 'Untitled'}).key();
        },

        _removeCategory: function(e) {
          this.$.categoryCollection.remove(e.currentTarget.category);
        },

        _toKeyArray: function(obj = {}){
          return Object.keys(obj);
        }
      });
    })();
  </script>

</dom-module>

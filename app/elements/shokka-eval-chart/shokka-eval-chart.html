<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="shokka-eval-chart">
  <template>
    <template template is="dom-if" if="{{comparison}}">
      <firebase-collection location="{{avgRef}}/dates"
                            order-by-child="date"
                            on-firebase-value="_onComparisonFirebaseValue"
                            data="{{avgDates}}"></firebase-collection>
    </template>
    <google-chart id="{{id}}" 
                  type="{{type}}" 
                  options='{{options}}'
                  data='[[data]]'>
    </google-chart>
  </template>
  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'shokka-eval-chart',

      properties: {
        id: {
          type: String,
          value: ''
        },
        avgData: {
          type: Array,
          // Set by onComparisonFirebaseValue
          value: []
        },
        userData: {
          type: Array,
          computed: '_setUserData(userAvgEvals)'
        },
        data: {
          type: Array,
          computed: '_computeData(id, userData, avgData)'
        },
        options: {
          type: Object,
          computed: '_computeOptions(id)'
        },
        type: {
          type: String,
          computed: '_computeType(id)'
        },
        comparison: {
          type: Boolean,
          computed: '_isComparison(id)'
        },
        header: {
          type: Array,
          value: ['Date', 'Professionalism', 'Skills', 'Work Completion' ]
        }
      },

      _isComparison: function(id){
        return id === 'comparison';
      },

      _computeType: function(id) {
        if (id === 'overTime') {
          return 'line';
        }
        return 'column';
      },

      _computeOptions: function(id){
        if (id === 'comparison') {
          return { 'title': 'Evaluation Comparison' };
        }
        else if (id === 'last') {
          return { 'title': 'Last Evaluation', 
                  'vAxis': { 'minValue': 0, 'maxValue': 100 }, 
                  'legend': { 'position': 'bottom'},
                  'hAxis': { 'textPosition': 'none' },
                  'chartArea': { 'width': '90%', 'height': '70%' } };
        }
        else if (id === 'overTime') {
          return { 'title': 'Performance Over Time', 'curveType': 'function' };
        }
        return {};
      },

      _computeData: function(id, userData, avgData){
        if (!userData) { 
          console.log('No user Data');
          return;
        }
        var data = [];
        if (id === 'comparison')
        {
          for (var i = 0, len = userData.length; i < len; i++) {
            data[i] = userData[i].slice();
          }
          for (var k = userData.length - 1; k > 0; k--) {
            for (var j = userData[k].length - 1; j > 0; j--) {
               avgData = avgData;
              // data[k][j] = userData[k][j] - avgData[k][j];
            }
          }
        }
        else {
          data = userData;
        }
        return data;
      },

      _onComparisonFirebaseValue: function() {
        this.avgData = [ this.header ];
        for (var i = 0; i < this.avgDates.length; i++) {
          this.avgData.push([this.avgDates[i].date, this.avgDates[i].categories.professionalism, 
                            this.avgDates[i].categories.skills, this.avgDates[i].categories.productivity]);
        }
      },

      _setUserData: function(userAvgEvals) {
        var userData = [ this.header ];
        if (this.id === 'last') {
          var arr = Object.keys( userAvgEvals || {} ).map(function ( key ) { 
            return userAvgEvals[key]; 
          });
          arr.sort(function(a, b){ return a.date.localeCompare(b.date); });
          var toAdd = arr[arr.length - 1];
          userData.push([toAdd.date, toAdd.professionalism, toAdd.skills, toAdd.productivity]);
        }
        else {
          for (var key in userAvgEvals) {
            // skip loop if the property is from prototype
            if (!userAvgEvals.hasOwnProperty(key)) {
              continue;
            }
            var tmp = ['', 0, 0, 0];
            var obj = userAvgEvals[key];
            for (var prop in obj) {
              // skip loop if the property is from prototype
              if(!obj.hasOwnProperty(prop)) {
                continue;
              }
              
              if(prop === 'date'){
                tmp[0] = obj[prop];
              }
              else if(prop === 'professionalism'){
                tmp[1] = obj[prop];
              }
              else if(prop === 'skills'){
                tmp[2] = obj[prop];
              }
              else if(prop === 'productivity'){
                tmp[3] = obj[prop];
              }
            }
            userData.push(tmp);
          }
        }
        return userData;
      }
  });
  })();
  </script>
</dom-module>

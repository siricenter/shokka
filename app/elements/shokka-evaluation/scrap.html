<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="shokka-evaluation">
  <template>
    <h2 class="page-title">Evaluation</h2>
    <paper-input name="date" label="Date (YYYY-MM)" value="{{evaluationDate}}" required></paper-input>
    <paper-input name="employee" label="Employee Name" value="{{employeeName}}" required></paper-input>
    <firebase-collection  location="{{firebaseEvalResultsLocation}}"
                          order-by-child="date"
                          equal-to="{{evaluationDate}}"
                          data="{{evalResults}}"
                          on-firebase-value="_log"></firebase-document>
    <firebase-collection  location="{{firebaseUsersLocation}}"
                          order-by-child="fullName"
                          equal-to="{{employeeName}}")
                          data="{{userId}}"
                          on-firebase-value="_log"></firebase-document>
    <paper-input name="manager" label="Manager Name" required></paper-input>
    <template template is="dom-repeat" items="{{evaluationCategories}}" as="category">
      <hr>
      <h1>{{category.title}}</h1>
      <hr>
      <template template is="dom-repeat" items="{{_toArray(category.criteria)}}" as="criterion">
        <p>{{_computeCriterionTitle(criterion, evaluationCriteria)}}: {{evaluation}}</p>
        <paper-slider pin snaps max="5" step="1" value="{{criterion.value}}"></paper-slider><br>
      </template>
    </template>
    <hr>

  </template>
  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'shokka-evaluation',

      properties: {
        evaluationCriteria: {
          type: Object,
          notify: false
        },
        evaluationCategories: {
          type: Object,
          notify: false
        },
        firebaseEvalResultsLocation: {
          type: String,
          computed: '_computeFirebaseEvalResultsLocation(baseRef)'
        },
        firebaseUsersLocation: {
          type: String,
          computed: '_computeFirebaseUsersLocation(baseRef)'
        },
        evaluation: {
          type: String,
          computed: '_computeEvaluation(evaluationDate, employeeName)'
        }
      },

      listeners: {
      },

      // Functions
      _toArray: function(obj) {
        return Object.keys(obj).map(function(key) {
          // console.log("Key: ", key);
          // console.log("Value: ", obj[key]);
          return {
            name: key,
            value: obj[key]
          };
        });
      },

      _computeCriterionTitle: function(criterion, evaluationCriteria){
        return ((evaluationCriteria || {})[criterion.name] || {}).title || "Title";
        // console.log(this.evaluationCategories);
        // console.log(this.evaluationCriteria);
      },

      _computeFirebaseEvalResultsLocation: function(baseRef){
        return baseRef + '/evalResults'
        // console.log(this.evaluationCategories);
        // console.log(this.evaluationCriteria);
      },

      _computeFirebaseUsersLocation: function(baseRef){
        return baseRef + '/users'
        // console.log(this.evaluationCategories);
        // console.log(this.evaluationCriteria);
      },

      submitHandler: function(e) {
        document.getElementById('formGet').submit();
      },

      resetHandler: function(e){

      },

      _computeEvaluation: function(evaluationDate, employeeName) {
        var evalResults = this.evalResults;
        var userId = this.userId;
        console.log('this.userId');
        console.log(this.userId);
        if(/^(20\d{2}-[01]\d)$/.test(evaluationDate) && /^\w+ *\w* \w+$/.test(employeeName)) {
          console.log(this.evalResults);
          console.log(this.userId);
          var evaluation = this.evalResults.filter(function( obj ) {
            console.log(obj.userId);
            console.log(userId)
            console.log(userId[0])
            console.log((userId[0] || {}).__firebaseKey__);
            return obj.userId == (userId[0] || {}).__firebaseKey__;
          }).pop();
          console.log(evaluation);
          return evaluation;
        }
        return;
      }
    });
  })();
  </script>
</dom-module>

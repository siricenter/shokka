<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="shokka-evaluation">
  <template>
    <script type="text/javascript" src="shokka-evaluation-functions.js"></script>
    <link rel="stylesheet" type="text/css" href="shokka-evaluation-styles.css">
    <style>
      :host {
        display: block;
      }
      :host .group {
        margin-left: 20px;
      }
      :host .group .question {
        margin-left: 20px;
      }
      :host .shokka-textarea {
        width: 45%;
        background: inherit;
        color: inherit;
        font-size: inherit;
        font-family: inherit;
        line-height: inherit;
        text-align: inherit;
      }
    </style>
    <paper-material elevation="1">
      <h2>New Evaluation</h2>
      <firebase-document    location="{{fbEvaluations}}"
                            on-firebase-value="_fbReturned"
                            data="{{evaluation}}"></firebase-document>
      <form is="iron-form" method="get" action="/" id="basic">
        <paper-dropdown-menu label="Employee" name="user" required>
          <paper-menu class="dropdown-content" selected="{{evaluation.user}}" attr-for-selected="value">
            <template is="dom-repeat" items="{{unitsManaged}}" as="unit">
              <shokka-evaluations-list-users unit="{{unit}}" org-id="[[orgId]]" base-ref="[[baseRef]]" value="{{evaluation.user}}"></shokka-evaluations-list-users>
            </template>
          </paper-menu>
        </paper-dropdown-menu>
        <paper-dropdown-menu label="Evaluation" name="evaluation" required>
          <paper-menu class="dropdown-content" selected="{{evaluation.template_id}}" attr-for-selected="value">
            <firebase-document  location="{{fbTemplates}}"
                                  order-by-child="order"
                                  on-firebase-value="_fbReturned"
                                  data="{{templates}}"></firebase-document>
              <template is="dom-repeat" items="[[_toArray(templates)]]" as="template">
                <paper-item value="[[template.__firebaseKey__]]">{{template.name}}</paper-item>
              </template>
          </paper-menu>
        </paper-dropdown-menu>
        <ul>
          <template is="dom-repeat" items="{{getGroups(evaluation.template_id, templates)}}" as="group">
            <li><h3>[[group.label]]</h3>
              <ul>
                <template is="dom-repeat" items="{{_toArray(group.questions)}}" as="question">
                  <li><h4>[[question.label]]</h4>
                    <div class="eval-tool">
                      <paper-slider pin snaps max="5" step="1" on-change="_sliderNotify" data-path$="evaluation.results.{{group.__firebaseKey__}}.{{question.__firebaseKey__}}.result" value="{{_value('evaluation.results.', group.__firebaseKey__, '.', question.__firebaseKey__, '.result')}}" hidden$="{{_isNotText(question.type)}}"></paper-slider>
                      <textarea class="shokka-textarea" rows="4" placeholder="Start typing here..." on-change="_textAreaNotify" data-path$="evaluation.results.{{group.__firebaseKey__}}.{{question.__firebaseKey__}}.result" hidden$="{{_isNotSlider(question.type)}}" value="{{_value('evaluation.results.', group.__firebaseKey__,'.',question.__firebaseKey__, '.result')}}"></textarea>
                      <textarea class="shokka-textarea" rows="4" placeholder="Notes about this question..." on-change="_textAreaNotify" data-path$="evaluation.results.{{group.__firebaseKey__}}.{{question.__firebaseKey__}}.note" value="{{_value('evaluation.results.', group.__firebaseKey__,'.',question.__firebaseKey__, '.note')}}"></textarea>
                    </div>
                  </li>
                </template>
              </ul>
            </li>
          </template>
        </ul>
        <paper-button raised on-click="removeEvaluationWarning" class="delete">Delete Evaluation</paper-button>
        <paper-button raised on-click="removeEvaluation" class="delete delete--confirmation hide">Are you sure?</paper-button>
      </form>
      <div id="fbSavedOutput" class="active">Changes have been saved</div>
    </paper-material>
  </template>
  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'shokka-evaluation',

      properties: {
      },

      observers: [
        '_fbEvaluations(baseRef, orgId, userInfo, evalId)'
      ],
      // Create a new evaluation template in firebase
      _createEvaluation: function() {
        this.evaluation = {};
        this.set("evaluation.created_on", EF.timeStamp());
        this.set('evaluation.created_by', this.userId.uid);
      },
      _toArray: function(obj) {
        return EF._toArray(obj);
      },
      getGroups: function(key, array) {
        return this._toArray(array[key].question_groups);
      },
      _notify: function(e) {
        return EF._notify.call(this, e);
      },
      _textAreaNotify: function(e) {
        var target = e.target,
          path = target.dataset.path,
          value = target.value;
        EF._blaze.call(this, path);
        this.set(path, value);
      },
      _sliderNotify: function(e) {
        var target = e.target,
          path = target.dataset.path;
        EF._blaze.call(this, path);
        this.set(path, target.value);
      },
      _fbReturned: function() {
        // If no template was returned - create one
        if (this.evaluation === null || this.evaluation === undefined) {
          this._createEvaluation();
        } else {
          // For every update from firebase, highlight the "auto-save" div
          this.set('evaluation.updated_on', EF.timeStamp());
          this.set('evaluation.updated_by', this.userId.uid);
          var high = this.$.fbSavedOutput;
          high.classList.remove('active');
          setTimeout(function() {
              high.classList.add('active');
          }, 1);
        }
      },
      // If no template id was passed in, create a new key
      _fbEvaluations: function(baseRef, orgId, userInfo, evalId){
        if (evalId === null || evalId === undefined) {
          evalId = EF._uid();
        }
        this.unitsManaged = Object.keys(userInfo.managedUnits);
        this.fbEvaluations = baseRef + '/orgs/' + orgId + '/evaluation/evaluations/' + evalId;
        this.fbTemplates = baseRef + '/orgs/' + orgId + '/evaluation/templates';
      },
      // Remove the node from firebase
      _removeButton: function(e){
        var path = e.target.dataset.path;
        if (path) {
          this.set(path, null);
        }
      }, 
      // Swap out the button for a confirmation button
      removeEvaluationWarning: function(e){
        e.target.classList.add('hide');
        e.target.parentElement.querySelector('.delete--confirmation.hide').classList.remove('hide');
      },
      removeEvaluation: function(){
        //TODO: How to push a delete up to firebase?
        delete this.evaluation;
        window.page('#!/evaluation/evaluations');
      },
      _isNotSlider: function(type) {
        return type === "slider";
      },
      _isNotText: function(type) {
        return type === "text";
      },
      _value: function() {
        return EF._getDeep([].slice.call(arguments).join(''), this);
      }
    });
  })();
  </script>
</dom-module>

<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="road-map">
  <template>
      <style>
      :host {
        display: inline;
      }
      paper-progress {
        display: inline;
        --paper-progress-active-color: var(--dark-primary-color);
        --paper-progress-height: .5rem;
      }

      paper-button{
        color: var(--secondary-text-color);
        margin:0 0 1.5rem;
        padding: .5rem 0 .5rem;
        width: 100%;
        font-weight: bold;
        font-size: 1.3rem;
      }

      iron-collapse {
        position: absolute;
        margin: -1rem 0 1.5rem;
        width: 99%;
        max-width: 100%;
        z-index: 1;
        background: var(--paper-menu-background-color);
      }
      .content li{
        list-style: none;
        font-size: 1rem;
        color: var(--secondary-text-color);

      }
      .steps {
        display: inline-block;
        width: 32%;
        position: relative;
      }

      paper-tooltip {
        --paper-tooltip-background:var(--default-primary-color);
        --paper-tooltip-opacity: .87;
        --paper-tooltip-text-color: var(--text-primary-color);
      }

      .item-title {
        width: 100%;
        margin: .3rem .1rem;
        font-size: 1rem;
      }

      .item-description{
        width: 100%;
        margin: .5rem .1rem .3rem;
        font-size: .8rem;
      }

      @media all and (min-width: 0px) and (max-width: 960px) {
        paper-button {
          font-size: 1rem;
        }

        .content li {
          font-size: .9rem;
        }

        .content ul {
          padding-left: 1rem;
        }

        .item-title {
          font-size: .8rem;
        }

        .item-description{
          font-size: .6rem;
        }
      }

      </style>
      <firebase-collection
        order-by-child="order"
        location="{{roadMapRef}}"
        data="{{steps}}"></firebase-collection>
        <template is="dom-repeat" items="{{steps}}" as="step">
          <div class="steps">
            <paper-button raised on-click="toggle">{{step.name}}</paper-button>
            <iron-collapse>
              <div class="content">
              <!-- consider using a paper-checkbox that will have all items that are completed checked off -->
                <ul>
                  <template is="dom-repeat" items="{{_toValueArray(step.items)}}" as="item">
                    <li>{{item.name}}</li>
                  </template>
                </ul>
              </div>
            </iron-collapse>
          </div>
        </template>

        <paper-progress id="progress" value="{{completed}}" valuemin='0' valuemax='100' >
        </paper-progress>
        <paper-tooltip for="progress" position="bottom" offset="10">
          <div class="item-title"><span>Paperwork</span></div>
          <div class="item-description"><span>Finish all required Paperwork</span></div>
        </paper-tooltip>

  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'road-map',

        properties: {
          completed: {
            type: Number,
            notify: true,
            computed: '_setCompleted(userRoadMap, steps)'
          },
          roadMapRef: {
            type: String,
            computed: '_computeRoadMapRef(baseRef)'
          }
        },

        _toValueArray: function(obj) {
          var dataArray = [];
          for(var o in obj) {
              dataArray.push(obj[o]);
          }
          dataArray.sort(function (a, b) {
            if (a.order > b.order) {
              return 1;
            }
            if (a.order < b.order) {
              return -1;
            }
            // a must be equal to b
            return 0;
          });
          return dataArray;
        },
        open: function(e) {
          e.currentTarget.children[1].open();
        },

        toggle: function(e) {
          e.target.nextElementSibling.toggle();
          var itemLists = [].slice.call(document.querySelectorAll('.steps'));

          document.body.addEventListener('click', function closeOnFocusLoss() {
            if (!itemLists.reduce(function(previousValue, currentValue) {
              return previousValue + (currentValue.contains(event.target));
            }, false)) {
              for (var i = 0, length = itemLists.length;i < length; i++) {
                itemLists[i].getElementsByTagName('iron-collapse')[0].hide();
              }

              document.body.removeEventListener('click', closeOnFocusLoss);
            }
          });
        },

        _computeRoadMapRef: function(baseRef) {
          return baseRef + '/roadMap';
        },

        _setCompleted: function(userRoadMap, steps) {
          var ret = 0;
          for (var userStep in userRoadMap) {
            // skip loop if the property is from prototype
            if (!userRoadMap.hasOwnProperty(userStep)) {
              continue;
            }

            var obj = userRoadMap[userStep]; // In setup for example
            var obj2 = steps.filter(function(elem) {
              return elem.__firebaseKey__ === userStep;
            }).pop();

            for (var prop in obj) {
              // skip loop if the property is from prototype
              if(!obj.hasOwnProperty(prop)) {
                continue;
              }

              if (obj[prop] === true) {
                ret += obj2.items[prop].weight;
              }
            }
          }
          return Math.round(ret/3);
        }
      });
    })();
  </script>

</dom-module>

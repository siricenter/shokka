<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="road-map">
  <template>
      <style>
      :host {
        display: inline;
      }

      paper-progress {
        display: inline;
        --paper-progress-active-color: var(--dark-primary-color);
        --paper-progress-height: .5rem;
      }

      .steps-button {
        color: var(--secondary-text-color);
        margin:0 0 1.5rem;
        padding: .5rem 0 .5rem;
        width: 100%;
        font-weight: bold;
        font-size: 1.3rem;
      }

      iron-collapse {
        position: absolute;
        margin: -1rem 0 1.5rem;
        width: 99%;
        max-width: 100%;
        z-index: 1;
        background: var(--paper-menu-background-color);
        border-radius: 5px;
        border: 1px solid var(--divider-color);
      }

      .content li{
        list-style: none;
        font-size: 1rem;
        color: var(--secondary-text-color);
        padding: .4rem 0;

      }

      .steps {
        display: inline-block;
        width: 32%;
        position: relative;
      }

      .list-item {
        max-width: 95%;
      }

      .toDo {
        background: var(--default-primary-color);
        opacity: .87;
        border-radius: 5px;
        color: var(--text-primary-color);
        max-width: 40%;
        margin: 1rem 0 0 25%;
      }
        
      .item-title {
        width: 100%;
        margin: .3rem .1rem;
        padding: .5rem .1rem 0 .3rem;
        font-size: 1rem;
      }

      .item-description{
        width: 100%;
        margin: .5rem .1rem .3rem;
        padding: 0 .1rem .5rem .3rem;
        font-size: .8rem;
      }

      @media all and (min-width: 0px) and (max-width: 960px) {
        paper-button {
          font-size: 1rem;
        }

        .item-list li {
          font-size: .9rem;
        }

        .item-list {
          padding-right: .2rem;
          padding-left: .5rem;
        }

        .item-title {
          font-size: .8rem;
        }

        .item-description{
          font-size: .6rem;
        }
      }

      </style>
      <firebase-collection
        order-by-child="order"
        location="{{roadMapRef}}"
        data="{{steps}}"></firebase-collection>
        <template is="dom-repeat" items="{{steps}}" as="step">
          <div class="steps">
            <paper-button class="steps-button"raised on-click="toggle">{{step.name}}</paper-button>
            <iron-collapse>
              <div class="content">
                <ul class="item-list">
                  <template is="dom-repeat" items="{{_toValueArray(step.items)}}" as="item">
                    <li >{{item.name}}</li>
                  </template>
                </ul>
              </div>
            </iron-collapse>
          </div>
        </template>

        <paper-progress id="progress" value="{{completed}}" valuemin='0' valuemax='100' >
        </paper-progress>
        <paper-material class="toDo">
          <div class="item-title"><span>{{toDo.name}}</span></div>
          <div class="item-description"><span>{{toDo.desc}}</span></div>
        </paper-material>
  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'road-map',

        properties: {
          completed: {
            type: Number,
            notify: true,
            computed: '_setCompleted(userRoadMap, steps)'
          },
          roadMapRef: {
            type: String,
            computed: '_computeRoadMapRef(baseRef)'
          },
          toDo: {
            type: Object,
            computed: '_computeToDo(userRoadMap, steps)'
          }
        },

        _computeToDo: function(userRoadMap, steps) {
          for (var step in steps) {
            // Convert to a sortable items list
            var sortable = [];
            for (var item in steps[step].items) {
              sortable.push([item, steps[step].items[item]]);
            }
            sortable.sort(function(a, b) {
              return a[1].order - b[1].order;
            });
            for (var sortableItem in sortable) {
              if(!userRoadMap[steps[step].__firebaseKey__][sortable[sortableItem][0]]) {
                return {name: sortable[sortableItem][1].name, desc: sortable[sortableItem][1].desc};
              }
            }
          }

          return {name: 'Complete', desc: 'You have nothing left to do!'};
        },

        _toValueArray: function(obj) {
          var dataArray = [];
          for(var o in obj) {
              dataArray.push(obj[o]);
          }
          dataArray.sort(function (a, b) {
            if (a.order > b.order) {
              return 1;
            }
            if (a.order < b.order) {
              return -1;
            }
            // a must be equal to b
            return 0;
          });
          return dataArray;
        },
        open: function(e) {
          e.currentTarget.children[1].open();
        },

        toggle: function(e) {
          e.target.nextElementSibling.toggle();
          var itemLists = [].slice.call(document.querySelectorAll('.steps'));

          document.body.addEventListener('click', function closeOnFocusLoss() {
            if (!itemLists.reduce(function(previousValue, currentValue) {
              return previousValue + (currentValue.contains(event.target));
            }, false)) {
              for (var i = 0, length = itemLists.length;i < length; i++) {
                itemLists[i].getElementsByTagName('iron-collapse')[0].hide();
              }

              document.body.removeEventListener('click', closeOnFocusLoss);
            }
          });
        },

        _computeRoadMapRef: function(baseRef) {
          return baseRef + '/roadMap';
        },

        _setCompleted: function(userRoadMap, steps) {
          var ret = 0;
          for (var userStep in userRoadMap) {
            // skip loop if the property is from prototype
            if (!userRoadMap.hasOwnProperty(userStep)) {
              continue;
            }

            var obj = userRoadMap[userStep]; // In setup for example
            var obj2 = steps.filter(function(elem) {
              return elem.__firebaseKey__ === userStep;
            }).pop();

            for (var prop in obj) {
              // skip loop if the property is from prototype
              if(!obj.hasOwnProperty(prop)) {
                continue;
              }

              if (obj[prop] === true) {
                ret += obj2.items[prop].weight;
              }
            }
          }
          return Math.round(ret/3);
        }
      });
    })();
  </script>

</dom-module>
